<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andrew's English | 9-Tense Mastery</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #2d8a57; --error: #c53030; --bg: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; color: #333; }
        .app-container { width: 100%; max-width: 850px; }
        .school-header { text-align: center; margin-bottom: 30px; }
        .card { background: white; padding: 35px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #eee; margin-bottom: 20px; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        .lesson-btn { padding: 20px; border: none; background: var(--primary); color: white; border-radius: 12px; cursor: pointer; transition: 0.3s; text-align: left; }
        .lesson-btn:hover { background: #1557b0; transform: translateY(-3px); }
        .btn-en { display: block; font-size: 0.8rem; opacity: 0.8; font-weight: 400; text-transform: uppercase; }
        .btn-zh { display: block; font-size: 1.15rem; font-weight: 700; margin-top: 4px; }
        .nav-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 850px; display: flex; justify-content: space-between; z-index: 1000; }
        .home-btn { background: #444; color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; }
        .rule-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.95rem; }
        .rule-table th, .rule-table td { border: 1px solid #dfe1e5; padding: 12px; text-align: left; }
        .rule-table th { background: #f8f9fa; color: var(--primary); }
        #rules-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 90%; max-width: 650px; border-radius: 20px; position: relative; max-height: 85vh; overflow-y: auto; }
        #capture-area { background: white; padding: 40px; border-radius: 0; color: #333; width: 700px; margin: 0 auto; }
        .review-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .correct-ans { color: var(--success); font-weight: bold; }
        input[type="text"] { width: 100%; padding: 18px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 20px; box-sizing: border-box; }
        .help-btn { color: var(--primary); cursor: pointer; font-weight: 600; text-decoration: underline; }
    </style>
</head>
<body>

<div id="rules-modal"><div class="modal-content"><span style="position:absolute;right:20px;top:15px;font-size:30px;cursor:pointer;" onclick="toggleModal(false)">&times;</span><div id="modal-body"></div></div></div>

<div class="app-container">
    <header class="school-header">
        <h1 style="color:var(--primary); margin:0;">Andrew's English</h1>
        <p style="color:#666; font-weight:600;">9-Tense Grammar Mastery Portal | èªæ³•å¤§å¸«å…¥å£</p>
    </header>

    <div id="login-card" class="card">
        <h2 style="text-align:center;">Student Login | å­¸ç”Ÿç™»å…¥</h2>
        <input type="text" id="student-name" placeholder="Enter your full name (è«‹è¼¸å…¥å§“å)">
        <button style="width:100%; background:var(--primary); color:white; padding:18px; border-radius:10px; border:none; font-weight:bold; cursor:pointer;" onclick="goToMenu()">Enter Classroom | é€²å…¥æ•™å®¤</button>
    </div>

    <div id="menu-card" class="card" style="display:none;">
        <h3 id="welcome-msg" style="color: var(--primary); text-align: center;"></h3>
        <div class="menu-grid" id="menu-buttons"></div>
    </div>

    <div id="rule-card" class="card" style="display:none;">
        <div id="rule-content"></div>
        <button style="width:100%; background: var(--success); color:white; padding:18px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-top: 20px;" onclick="startQuiz()">Start Quiz | é–‹å§‹æ¸¬é©—</button>
    </div>

    <div id="quiz-container" class="card" style="display:none;">
        <div id="current-tense-display" style="background:var(--primary); color:white; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center; font-weight:bold;"></div>
        <div id="question-area"></div>
    </div>

    <div id="results-container" class="card" style="display:none;">
        <div id="capture-area">
            <h2 style="text-align:center;">Performance Report</h2>
            <div id="score-summary" style="text-align:center; border: 3px dashed #e1e4e8; padding: 30px; margin: 25px 0; border-radius: 15px;"></div>
            <div id="review-list"></div>
        </div>
        <button style="background:#ff9800; color:white; width:100%; padding:20px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1.1rem; margin-top:20px;" onclick="saveAsPDF()">ğŸ“„ Save Result to Computer | å„²å­˜ PDF æˆç¸¾å–®</button>
    </div>

    <div id="global-nav" class="nav-container" style="display:none;">
        <button class="home-btn" onclick="location.reload()">ğŸ  Home | é¦–é </button>
    </div>
</div>

<script>
    let studentName = ""; let currentTense = ""; let currentIdx = 0; let userAnswers = [];

    const v3Table = `
    <h4 style="color:#c53030;">Past Participle (V3) Reference | éå»åˆ†è©å°ç…§è¡¨:</h4>
    <table class="rule-table">
        <tr><th>V1 (Base)</th><th>V2 (Past)</th><th>V3 (Participle)</th></tr>
        <tr><td>eat</td><td>ate</td><td>eaten</td></tr><tr><td>go</td><td>went</td><td>gone</td></tr>
        <tr><td>do</td><td>did</td><td>done</td></tr><tr><td>write</td><td>wrote</td><td>written</td></tr>
        <tr><td>see</td><td>saw</td><td>seen</td></tr><tr><td>buy</td><td>bought</td><td>bought</td></tr>
        <tr><td>take</td><td>took</td><td>taken</td></tr><tr><td>speak</td><td>spoke</td><td>spoken</td></tr>
    </table>`;

    const data = {
        presentSimple: {
            title: "Present Simple ç¾åœ¨ç°¡å–®å¼",
            usage: "Habits and general facts. (ç¿’æ…£ã€äº‹å¯¦ã€çœŸç†ã€‚)",
            table: `<table class="rule-table"><tr><th>I/You/We/They</th><td>Verb</td></tr><tr><th>He/She/It</th><td>Verb + s/es</td></tr></table>`,
            contractions: ["do not â†’ don't", "does not â†’ doesn't"],
            questions: [
                {q: "He ___ (drink) milk every day.", a: "drinks", t: "ä»–æ¯å¤©å–ç‰›å¥¶ã€‚"},{q: "They ___ (not like) apples.", a: "do not like", t: "ä»–å€‘ä¸å–œæ­¡è˜‹æœã€‚"},
                {q: "Water ___ (boil) at 100Â°C.", a: "boils", t: "æ°´åœ¨100åº¦æ²¸é¨°ã€‚"},{q: "She ___ (study) English.", a: "studies", t: "å¥¹å­¸è‹±æ–‡ã€‚"},
                {q: "Cats ___ (catch) mice.", a: "catch", t: "è²“æŠ“è€é¼ ã€‚"},{q: "The sun ___ (rise) in the east.", a: "rises", t: "å¤ªé™½å¾æ±æ–¹å‡èµ·ã€‚"},
                {q: "I ___ (not play) soccer.", a: "do not play", t: "æˆ‘ä¸è¸¢è¶³çƒã€‚"},{q: "We ___ (live) in Taipei.", a: "live", t: "æˆ‘å€‘ä½åœ¨å°åŒ—ã€‚"},
                {q: "He ___ (watch) TV daily.", a: "watches", t: "ä»–æ¯å¤©çœ‹é›»è¦–ã€‚"},{q: "You ___ (not speak) French.", a: "do not speak", t: "ä½ ä¸èªªæ³•èªã€‚"}
            ]
        },
        pastSimple: {
            title: "Past Simple éå»ç°¡å–®å¼",
            usage: "Completed actions in the past. (éå»å·²å®Œæˆçš„å‹•ä½œã€‚)",
            table: `<table class="rule-table"><tr><th>All Subjects</th><td>V2 (ed / irregular)</td></tr></table>`,
            contractions: ["did not â†’ didn't"],
            questions: [
                {q: "I ___ (see) him yesterday.", a: "saw", t: "æˆ‘æ˜¨å¤©çœ‹åˆ°ä»–ã€‚"},{q: "They ___ (not go) home.", a: "did not go", t: "ä»–å€‘æ²’å›å®¶ã€‚"},
                {q: "She ___ (eat) a sandwich.", a: "ate", t: "å¥¹åƒäº†ä¸€å€‹ä¸‰æ˜æ²»ã€‚"},{q: "We ___ (buy) a car last year.", a: "bought", t: "æˆ‘å€‘å»å¹´è²·äº†è»Šã€‚"},
                {q: "He ___ (finish) his work.", a: "finished", t: "ä»–å®Œæˆäº†å·¥ä½œã€‚"},{q: "It ___ (rain) last night.", a: "rained", t: "æ˜¨æ™šä¸‹é›¨äº†ã€‚"},
                {q: "You ___ (not call) me.", a: "did not call", t: "ä½ æ²’æ‰“çµ¦æˆ‘ã€‚"},{q: "They ___ (arrive) late.", a: "arived", t: "ä»–å€‘é²åˆ°äº†ã€‚"},
                {q: "I ___ (write) a letter.", a: "wrote", t: "æˆ‘å¯«äº†ä¸€å°ä¿¡ã€‚"},{q: "She ___ (not stay) long.", a: "did not stay", t: "å¥¹æ²’å¾…å¾ˆä¹…ã€‚"}
            ]
        },
        futureSimple: {
            title: "Future Simple æœªä¾†ç°¡å–®å¼",
            usage: "Future plans and predictions. (æœªä¾†çš„è¨ˆç•«ã€é æ¸¬ã€‚)",
            table: `<table class="rule-table"><tr><th>All Subjects</th><td>will + V1</td></tr></table>`,
            contractions: ["will not â†’ won't"],
            questions: [
                {q: "I ___ (help) you tomorrow.", a: "will help", t: "æˆ‘æ˜å¤©æœƒå¹«ä½ ã€‚"},{q: "They ___ (not come) tonight.", a: "will not come", t: "ä»–å€‘ä»Šæ™šä¸æœƒä¾†ã€‚"},
                {q: "She ___ (travel) to Japan.", a: "will travel", t: "å¥¹æœƒå»æ—¥æœ¬æ—…è¡Œã€‚"},{q: "We ___ (not forget) you.", a: "will not forget", t: "æˆ‘å€‘ä¸æœƒå¿˜è¨˜ä½ ã€‚"},
                {q: "He ___ (buy) a house.", a: "will buy", t: "ä»–æœƒè²·æˆ¿å­ã€‚"},{q: "It ___ (be) sunny.", a: "will be", t: "å¤©æ°£æœƒæ™´æœ—ã€‚"},
                {q: "You ___ (win) the race.", a: "will win", t: "ä½ æœƒè´å¾—æ¯”è³½ã€‚"},{q: "I ___ (not watch) the game.", a: "will not watch", t: "æˆ‘ä¸æœƒçœ‹æ¯”è³½ã€‚"},
                {q: "They ___ (bring) some food.", a: "will bring", t: "ä»–å€‘æœƒå¸¶é£Ÿç‰©ã€‚"},{q: "She ___ (not tell) the secret.", a: "will not tell", t: "å¥¹ä¸æœƒèªªå‡ºç§˜å¯†ã€‚"}
            ]
        },
        presentContinuous: {
            title: "Present Continuous ç¾åœ¨é€²è¡Œå¼",
            usage: "Actions happening right now. (ç¾åœ¨æ­£åœ¨é€²è¡Œã€‚)",
            table: `<table class="rule-table"><tr><th>I am / He is / They are</th><td>Verb + ing</td></tr></table>`,
            contractions: ["is not â†’ isn't", "are not â†’ aren't"],
            questions: [
                {q: "I ___ (read) now.", a: "am reading", t: "æˆ‘ç¾åœ¨æ­£åœ¨çœ‹æ›¸ã€‚"},{q: "They ___ (not study).", a: "are not studying", t: "ä»–å€‘æ²’åœ¨è®€æ›¸ã€‚"},
                {q: "She ___ (cook) dinner.", a: "is cooking", t: "å¥¹æ­£åœ¨ç…®æ™šé¤ã€‚"},{q: "We ___ (not watch) TV.", a: "are not watching", t: "æˆ‘å€‘æ²’åœ¨çœ‹é›»è¦–ã€‚"},
                {q: "He ___ (play) piano.", a: "is playing", t: "ä»–æ­£åœ¨å½ˆé‹¼ç´ã€‚"},{q: "You ___ (listen) to me.", a: "are listening", t: "ä½ æ­£åœ¨è½æˆ‘èªªè©±ã€‚"},
                {q: "The dog ___ (bark).", a: "is barking", t: "ç‹—æ­£åœ¨å«ã€‚"},{q: "It ___ (rain) outside.", a: "is raining", t: "å¤–é¢æ­£åœ¨ä¸‹é›¨ã€‚"},
                {q: "I ___ (not sleep) yet.", a: "am not sleeping", t: "æˆ‘é‚„æ²’åœ¨ç¡è¦ºã€‚"},{q: "They ___ (run) fast.", a: "are running", t: "ä»–å€‘æ­£åœ¨è·‘ã€‚"}
            ]
        },
        pastContinuous: {
            title: "Past Continuous éå»é€²è¡Œå¼",
            usage: "Actions happening at a past time. (éå»æŸæ™‚æ­£åœ¨é€²è¡Œã€‚)",
            table: `<table class="rule-table"><tr><th>I was / They were</th><td>Verb + ing</td></tr></table>`,
            contractions: ["was not â†’ wasn't", "were not â†’ weren't"],
            questions: [
                {q: "I ___ (eat) at 7 PM.", a: "was eating", t: "æˆ‘ä¸ƒé»åœ¨åƒé£¯ã€‚"},{q: "They ___ (not study).", a: "were not studying", t: "ä»–å€‘ç•¶æ™‚æ²’åœ¨è®€æ›¸ã€‚"},
                {q: "She ___ (sleep) then.", a: "was sleeping", t: "å¥¹é‚£æ™‚åœ¨ç¡è¦ºã€‚"},{q: "We ___ (walking) home.", a: "were walking", t: "æˆ‘å€‘ç•¶æ™‚åœ¨èµ°è·¯å›å®¶ã€‚"},
                {q: "He ___ (not drive).", a: "was not driving", t: "ä»–é‚£æ™‚æ²’åœ¨é–‹è»Šã€‚"},{q: "You ___ (sing) well.", a: "were singing", t: "ä½ é‚£æ™‚å”±å¾—å¾ˆå¥½ã€‚"},
                {q: "It ___ (snow) yesterday.", a: "was snowing", t: "æ˜¨å¤©ç•¶æ™‚æ­£åœ¨ä¸‹é›ªã€‚"},{q: "I ___ (not looking).", a: "was not looking", t: "æˆ‘ç•¶æ™‚æ²’åœ¨çœ‹ã€‚"},
                {q: "They ___ (work) hard.", a: "were working", t: "ä»–å€‘ç•¶æ™‚åœ¨åŠªåŠ›å·¥ä½œã€‚"},{q: "She ___ (wearing) a hat.", a: "was wearing", t: "å¥¹é‚£æ™‚æˆ´è‘—å¸½å­ã€‚"}
            ]
        },
        futureContinuous: {
            title: "Future Continuous æœªä¾†é€²è¡Œå¼",
            usage: "Actions happening in the future. (æœªä¾†æŸæ™‚å°‡åœ¨é€²è¡Œã€‚)",
            table: `<table class="rule-table"><tr><th>All Subjects</th><td>will be + ing</td></tr></table>`,
            contractions: ["will not be â†’ won't be"],
            questions: [
                {q: "I ___ (wait) for you.", a: "will be waiting", t: "æˆ‘åˆ°æ™‚æœƒåœ¨é‚£ç­‰ä½ ã€‚"},{q: "They ___ (not work).", a: "will not be working", t: "ä»–å€‘åˆ°æ™‚ä¸æœƒåœ¨å·¥ä½œã€‚"},
                {q: "She ___ (flying) now.", a: "will be flying", t: "å¥¹é‚£æ™‚å°‡åœ¨é£›è¡Œã€‚"},{q: "We ___ (having) lunch.", a: "will be having", t: "æˆ‘å€‘é‚£æ™‚å°‡åœ¨åƒåˆé¤ã€‚"},
                {q: "He ___ (not sleep).", a: "will not be sleeping", t: "ä»–åˆ°æ™‚å°‡ä¸æœƒåœ¨ç¡è¦ºã€‚"},{q: "You ___ (study) all day.", a: "will be studying", t: "ä½ é‚£æ™‚å°‡è®€ä¸€æ•´å¤©æ›¸ã€‚"},
                {q: "It ___ (rain) later.", a: "will be raining", t: "æ™šé»å°‡æœƒä¸‹é›¨ã€‚"},{q: "I ___ (not using) it.", a: "will not be using", t: "æˆ‘åˆ°æ™‚ä¸æœƒä½¿ç”¨å®ƒã€‚"},
                {q: "They ___ (swim) soon.", a: "will be swimming", t: "ä»–å€‘å¾ˆå¿«å°‡åœ¨æ¸¸æ³³ã€‚"},{q: "She ___ (wear) red.", a: "will be wearing", t: "å¥¹é‚£æ™‚å°‡ç©¿ç´…è‰²ã€‚"}
            ]
        },
        presentPerfect: {
            title: "Present Perfect ç¾åœ¨å®Œæˆå¼",
            usage: "Experience or ongoing actions. (ç¶“é©—ã€æŒçºŒåˆ°ç¾åœ¨çš„å‹•ä½œã€‚)",
            table: `<table class="rule-table"><tr><th>I have / He has</th><td>V3 (Past Participle)</td></tr></table>`,
            contractions: ["have not â†’ haven't", "has not â†’ hasn't"],
            questions: [
                {q: "I ___ (see) Paris.", a: "have seen", t: "æˆ‘å»éå·´é»ã€‚"},{q: "She ___ (not finish).", a: "has not finished", t: "å¥¹é‚„æ²’å¯«å®Œã€‚"},
                {q: "They ___ (live) here.", a: "have lived", t: "ä»–å€‘ä½åœ¨é€™ã€‚"},{q: "He ___ (lose) his key.", a: "has lost", t: "ä»–ä¸Ÿäº†é‘°åŒ™ã€‚"},
                {q: "We ___ (not meet) him.", a: "have not met", t: "æˆ‘å€‘æ²’è¦‹éä»–ã€‚"},{q: "You ___ (grown) taller.", a: "have grown", t: "ä½ é•·é«˜äº†ã€‚"},
                {q: "Cat ___ (eat) its food.", a: "has eaten", t: "è²“åƒå®Œé£¯äº†ã€‚"},{q: "I ___ (not visit) him.", a: "have not visited", t: "æˆ‘æ²’å»æ‹œè¨ªä»–ã€‚"},
                {q: "It ___ (stop) raining.", a: "has stopped", t: "é›¨åœäº†ã€‚"},{q: "They ___ (buy) a house.", a: "have bought", t: "ä»–å€‘è²·äº†æˆ¿ã€‚"}
            ]
        },
        pastPerfect: {
            title: "Past Perfect éå»å®Œæˆå¼",
            usage: "Action before another past action. (éå»æŸäº‹ä¹‹å‰å·²å®Œæˆã€‚)",
            table: `<table class="rule-table"><tr><th>All Subjects</th><td>had + V3</td></tr></table>`,
            contractions: ["had not â†’ hadn't"],
            questions: [
                {q: "I ___ (eat) already.", a: "had eaten", t: "æˆ‘é‚£æ™‚å·²ç¶“åƒéäº†ã€‚"},{q: "She ___ (not arrive).", a: "had not arrived", t: "å¥¹é‚£æ™‚é‚„æ²’åˆ°ã€‚"},
                {q: "They ___ (left) earlier.", a: "had left", t: "ä»–å€‘æ—©åœ¨é‚£ä¹‹å‰é›¢é–‹äº†ã€‚"},{q: "He ___ (lost) his way.", a: "had lost", t: "ä»–é‚£æ™‚è¿·è·¯äº†ã€‚"},
                {q: "We ___ (finished) work.", a: "had finished", t: "æˆ‘å€‘åœ¨é‚£ä¹‹å‰å·²å®Œå·¥ã€‚"},{q: "It ___ (started) raining.", a: "had started", t: "é›¨åœ¨é‚£ä¹‹å‰å·²é–‹å§‹ä¸‹ã€‚"},
                {q: "You ___ (not seen) it.", a: "had not seen", t: "ä½ é‚£æ™‚é‚„æ²’çœ‹éã€‚"},{q: "I ___ (written) the test.", a: "had written", t: "æˆ‘é‚£æ™‚å·²å¯«å®Œæ¸¬é©—ã€‚"},
                {q: "They ___ (bought) it.", a: "had bought", t: "ä»–å€‘åœ¨é‚£ä¹‹å‰è²·äº†å®ƒã€‚"},{q: "She ___ (told) me.", a: "had told", t: "å¥¹æ—©åœ¨é‚£ä¹‹å‰å°±å‘Šè¨´æˆ‘ã€‚"}
            ]
        },
        futurePerfect: {
            title: "Future Perfect æœªä¾†å®Œæˆå¼",
            usage: "Action finished by a future time. (æœªä¾†æŸæ™‚ä¹‹å‰å°‡å®Œå·¥ã€‚)",
            table: `<table class="rule-table"><tr><th>All Subjects</th><td>will have + V3</td></tr></table>`,
            contractions: ["will not have â†’ won't have"],
            questions: [
                {q: "I ___ (finish) by 5 PM.", a: "will have finished", t: "äº”é»å‰æˆ‘å°‡å·²å®Œå·¥ã€‚"},{q: "She ___ (not arrive).", a: "will not have arrived", t: "å¥¹åˆ°æ™‚é‚„ä¸æœƒåˆ°ã€‚"},
                {q: "They ___ (left) soon.", a: "will have left", t: "ä»–å€‘å¾ˆå¿«å°±æœƒé›¢é–‹äº†ã€‚"},{q: "We ___ (saved) money.", a: "will have saved", t: "åˆ°æ™‚æˆ‘å€‘å°‡å·²å­˜å¥½éŒ¢ã€‚"},
                {q: "He ___ (graduated).", a: "will have graduated", t: "åˆ°æ™‚ä»–å°‡å·²ç•¢æ¥­ã€‚"},{q: "I ___ (bought) a house.", a: "will have bought", t: "åˆ°æ™‚æˆ‘å°‡å·²è²·å¥½æˆ¿ã€‚"},
                {q: "Sun ___ (set) by 7 PM.", a: "will have set", t: "å¤ªé™½ä¸ƒé»å‰å°‡ä¸‹å±±ã€‚"},{q: "You ___ (read) it all.", a: "will have read", t: "åˆ°æ™‚ä½ å°‡å·²è®€å®Œã€‚"},
                {q: "They ___ (not built) it.", a: "will not have built", t: "ä»–å€‘åˆ°æ™‚é‚„ä¸æœƒè“‹å¥½ã€‚"},{q: "Winter ___ (ended).", a: "will have ended", t: "ä¸‰æœˆå‰å†¬å¤©å°‡å·²çµæŸã€‚"}
            ]
        }
    };

    function clean(text) {
        if (!text) return "";
        return text.toLowerCase().trim()
            .replace(/[â€˜â€™â€œâ€]/g, "'").replace(/won't/g, "will not")
            .replace(/haven't/g, "have not").replace(/hasn't/g, "has not")
            .replace(/isn't/g, "is not").replace(/aren't/g, "are not")
            .replace(/wasn't/g, "was not").replace(/weren't/g, "were not")
            .replace(/don't/g, "do not").replace(/doesn't/g, "does not")
            .replace(/hadn't/g, "had not").replace(/'ve/g, " have")
            .replace(/'s/g, " is").replace(/'ll/g, " will")
            .replace(/[.,!?;:]/g, "").replace(/\s+/g, " ");
    }

    function goToMenu() {
        studentName = document.getElementById('student-name').value.trim();
        if (!studentName) return alert("Enter name!");
        document.getElementById('login-card').style.display = 'none';
        document.getElementById('menu-card').style.display = 'block';
        document.getElementById('global-nav').style.display = 'flex';
        document.getElementById('welcome-msg').innerText = `Hello, ${studentName}!`;
        
        let grid = document.getElementById('menu-buttons');
        grid.innerHTML = "";
        Object.keys(data).forEach(key => {
            const parts = data[key].title.split(' ');
            const zh = parts.pop();
            const en = parts.join(' ');
            grid.innerHTML += `<button class="lesson-btn" onclick="loadTense('${key}')">
                <span class="btn-en">${en}</span><span class="btn-zh">${zh}</span>
            </button>`;
        });
    }

    function loadTense(key) {
        currentTense = key;
        const t = data[key];
        document.getElementById('rule-content').innerHTML = `
            <h2 style="color:var(--primary);">${t.title}</h2>
            <p style="background:#fdfae3; border-left:5px solid #f1c40f; padding:15px;"><strong>When to use (ç”¨æ³•èª¬æ˜):</strong><br>${t.usage}</p>
            ${t.table}
            <div class="help-btn" onclick="toggleModal(true)">View Contractions & V3 Help (æŸ¥çœ‹ç¸®å¯«èˆ‡åˆ†è©è¡¨)</div>
        `;
        document.getElementById('menu-card').style.display = 'none';
        document.getElementById('rule-card').style.display = 'block';
    }

    function toggleModal(show) {
        if (show) {
            const t = data[currentTense];
            document.getElementById('modal-body').innerHTML = `
                <h3>${t.title} Rules</h3>
                ${t.table}
                <p><strong>Common Contractions:</strong> ${t.contractions.join(', ')}</p>
                ${v3Table}`;
            document.getElementById('rules-modal').style.display = 'block';
        } else document.getElementById('rules-modal').style.display = 'none';
    }

    function startQuiz() {
        currentIdx = 0; userAnswers = [];
        document.getElementById('rule-card').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        showQuestion();
    }

    function showQuestion() {
        const q = data[currentTense].questions[currentIdx];
        document.getElementById('current-tense-display').innerText = data[currentTense].title;
        document.getElementById('question-area').innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>Question ${currentIdx+1}/10</span>
                <span class="help-btn" onclick="toggleModal(true)">View Rules & V3 Help</span>
            </div>
            <h3 style="margin-top:0;">${q.q}</h3>
            <p style="color:#666;">${q.t}</p>
            <input type="text" id="ans-input" autocomplete="off" onkeypress="if(event.key==='Enter') next()">
            <button style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; cursor:pointer;" onclick="next()">Next Question | ä¸‹ä¸€é¡Œ</button>
        `;
        document.getElementById('ans-input').focus();
    }

    function next() {
        const userVal = document.getElementById('ans-input').value;
        const correctVal = data[currentTense].questions[currentIdx].a;
        userAnswers[currentIdx] = { q: data[currentTense].questions[currentIdx].q, user: userVal, correct: correctVal, isCorrect: clean(userVal) === clean(correctVal) };
        currentIdx++;
        if (currentIdx < 10) showQuestion(); else showResults();
    }

    function showResults() {
        const score = userAnswers.filter(a => a.isCorrect).length;
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        document.getElementById('score-summary').innerHTML = `<h1>${score*10}%</h1><p>${studentName} - ${data[currentTense].title}</p>`;
        let rev = ""; userAnswers.forEach(a => {
            rev += `<div class="review-item"><b>${a.q}</b><br><span style="color:${a.isCorrect?'green':'red'}">${a.user || "Empty"}</span> ${a.isCorrect?'':`| Correct: ${a.correct}`}</div>`;
        });
        document.getElementById('review-list').innerHTML = rev;
    }

    async function saveAsPDF() {
        const { jsPDF } = window.jspdf;
        const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2 });
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 10, 210, (canvas.height * 210) / canvas.width);
        pdf.save(`${studentName}_English_Result.pdf`);
    }
</script>
</body>
</html>
