<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andrew's English | 9-Tense Mastery</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>    <style>
        :root { --primary: #1a73e8; --success: #2d8a57; --error: #c53030; --bg: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 850px; position: relative; padding-bottom: 100px; }
        .school-header { text-align: center; margin-bottom: 20px; }
        .school-logo { max-width: 280px; height: auto; border-radius: 10px; }
        .card { background: white; padding: 35px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 20px; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .lesson-btn { padding: 18px; border: none; background: var(--primary); color: white; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 0.95rem; }
        .lesson-btn:hover { background: #1557b0; transform: translateY(-2px); }
        .nav-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 850px; display: flex; justify-content: space-between; z-index: 1000; }
        .home-btn { background: #444; color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; }
        .prev-btn-nav { background: white; color: #444; border: 1px solid #ddd; padding: 12px 25px; border-radius: 30px; cursor: pointer; visibility: hidden; font-weight: bold; }
        .tense-header-bar { background: var(--primary); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; }
        .rule-table { width: 100%; border-collapse: collapse; margin: 15px 0; background: #fff; }
        .rule-table th, .rule-table td { border: 1px solid #dfe1e5; padding: 12px; text-align: left; }
        .rule-table th { background: #f8f9fa; color: var(--primary); }
        input[type="text"] { width: 100%; padding: 18px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 20px; box-sizing: border-box; }
        #rules-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 20px; position: relative; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .close-modal { position: absolute; right: 20px; top: 15px; font-size: 30px; cursor: pointer; color: #666; }
        .review-item { border-bottom: 1px solid #eee; padding: 15px 0; font-size: 0.95rem; }
        .correct-ans { color: var(--success); font-weight: bold; }
        .wrong-ans { color: var(--error); text-decoration: line-through; margin-right: 10px; }
     #capture-area {
    background: white;
    padding: 30px;
    border-radius: 10px;
    color: #333;
    /* This ensures the PDF background isn't black or transparent */
}
    </style>
</head>
<body>

<div id="rules-modal"><div class="modal-content"><span class="close-modal" onclick="toggleModal(false)">&times;</span><div id="modal-body"></div></div></div>

<div class="app-container">
    <header class="school-header">
        <h1 style="color: var(--primary); margin-bottom: 5px;">Andrew's English</h1>
        <p style="color: #666; margin-top: 0;">Online Learning Portal</p>
    </header>

    <div id="login-card" class="card">
        <h2 style="text-align:center; margin-top: 0;">Student Login <span style="font-size: 0.8rem; color:#888; display: block;">Ë´ãËº∏ÂÖ•ÂßìÂêçÁôªÂÖ•</span></h2>
        <input type="text" id="student-name" placeholder="Your Name (e.g. Andrew)">
        <button style="width:100%; background:var(--primary); color:white; padding:18px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; font-size: 1.1rem;" onclick="goToMenu()">Enter Classroom</button>
    </div>

    <div id="menu-card" class="card" style="display:none;">
        <h3 id="welcome-msg" style="color: var(--primary); text-align: center; margin-top: 0;"></h3>
        <p style="text-align: center; color: #666;">Select a tense to start your practice:</p>
        <div class="menu-grid" id="menu-buttons"></div>
    </div>

    <div id="rule-card" class="card" style="display:none;">
        <div id="rule-content"></div>
        <button style="width:100%; background: var(--success); color:white; padding:18px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; font-size: 1.1rem; margin-top: 20px;" onclick="startQuiz()">I'm Ready - Start Quiz!</button>
    </div>

    <div id="quiz-container" class="card" style="display:none;">
        <div id="current-tense-display" class="tense-header-bar"></div>
        <div id="question-area"></div>
    </div>

    <div id="results-container" class="card" style="display:none;">
        <div id="capture-area">
            <h2 style="text-align:center; margin-top: 0;">Performance Report</h2>
            <div id="score-summary" style="text-align:center; border: 3px dashed #e1e4e8; padding: 30px; margin-bottom: 25px; border-radius: 15px;"></div>
        </div>
        <button style="background:#ff9800; color:white; width:100%; padding:18px; border:none; border-radius:10px; cursor:pointer; font-weight: bold; margin-bottom:20px;" 
        onclick="saveAsPDF()">
        üìÑ Save Result as PDF
        </button>
        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">Answer Review:</h3>
        <div id="review-list"></div>
    </div>

    <div id="global-nav" class="nav-container" style="display:none;">
        <button class="home-btn" onclick="backToHome()">üè† Home Menu</button>
        <button id="prev-btn" class="prev-btn-nav" onclick="prevQuestion()">‚¨Ö Previous</button>
    </div>
</div>

<script>
    let studentName = "";
    let currentTense = "";
    let currentIdx = 0;
    let userAnswers = [];

   const data = {
    presentSimple: {
        title: "Present Simple ÁèæÂú®Á∞°ÂñÆÂºè", 
        usage: "Habits and general truths. (ÁøíÊÖ£ËàáÊôÆÈÅçÁúüÁêÜ)",
        // ... (rest of data)
    },
    pastSimple: {
        title: "Past Simple ÈÅéÂéªÁ∞°ÂñÆÂºè", 
        usage: "Completed actions in the past. (ÈÅéÂéªÂ∑≤ÂÆåÊàêÁöÑÂãï‰Ωú)",
        // ...
    },
    futureSimple: {
        title: "Future Simple Êú™‰æÜÁ∞°ÂñÆÂºè", 
        usage: "Future plans and predictions. (Êú™‰æÜÁöÑË®àÁï´ËàáÈ†êÊ∏¨)",
        // ...
    },
    presentContinuous: {
        title: "Present Continuous ÁèæÂú®ÈÄ≤Ë°åÂºè", 
        usage: "Actions happening right now. (ÁèæÂú®Ê≠£Âú®ÈÄ≤Ë°åÁöÑÂãï‰Ωú)",
        // ...
    },
    pastContinuous: {
        title: "Past Continuous ÈÅéÂéªÈÄ≤Ë°åÂºè", 
        usage: "Action in progress at a specific past time. (ÈÅéÂéªÊüêÂÄãÊôÇÈñìÈªûÊ≠£Âú®ÈÄ≤Ë°åÁöÑÂãï‰Ωú)",
        // ...
    },
    futureContinuous: {
        title: "Future Continuous Êú™‰æÜÈÄ≤Ë°åÂºè", 
        usage: "Action that will be in progress in the future. (Êú™‰æÜÊüêÂÄãÊôÇÈñìÈªûÂ∞áÂú®ÈÄ≤Ë°åÁöÑÂãï‰Ωú)",
        // ...
    },
    presentPerfect: {
        title: "Present Perfect ÁèæÂú®ÂÆåÊàêÂºè", 
        usage: "Life experience or actions linked to now. (‰∫∫ÁîüÁ∂ìÈ©óÊàñËàáÁèæÂú®Áõ∏ÈóúÁöÑÈÅéÂéªÂãï‰Ωú)",
        // ...
    },
    pastPerfect: {
        title: "Past Perfect ÈÅéÂéªÂÆåÊàêÂºè", 
        usage: "Action completed before another past action. (Âú®ÈÅéÂéªÊüê‰∫ã‰πãÂâçÂ∑≤ÂÆåÊàêÁöÑÂãï‰Ωú)",
        // ...
    },
    futurePerfect: {
        title: "Future Perfect Êú™‰æÜÂÆåÊàêÂºè", 
        usage: "Action that will be finished by a future time. (Âú®Êú™‰æÜÊüêÂÄãÊôÇÈñìÈªûÂâçÂ∞áÂÆåÊàêÁöÑÂãï‰Ωú)",
        // ...
    }
};

    function clean(text) {
        if (!text) return "";
        return text.toLowerCase().trim()
            .replace(/[‚Äò‚Äô‚Äú‚Äù]/g, "'")
            .replace(/won't/g, "will not").replace(/haven't/g, "have not")
            .replace(/hasn't/g, "has not").replace(/hadn't/g, "had not")
            .replace(/isn't/g, "is not").replace(/aren't/g, "are not")
            .replace(/wasn't/g, "was not").replace(/weren't/g, "were not")
            .replace(/n't/g, " not").replace(/'ll/g, " will")
            .replace(/[.,!?;:]/g, "").replace(/\s+/g, " ");
    }

    function goToMenu() {
        let nameInput = document.getElementById('student-name').value.trim();
        if (!nameInput) { alert("Please enter your name!"); return; }
        studentName = nameInput;
        document.getElementById('login-card').style.display = 'none';
        document.getElementById('menu-card').style.display = 'block';
        document.getElementById('global-nav').style.display = 'flex';
        document.getElementById('welcome-msg').innerText = `Welcome back, ${studentName}!`;
        
        const grid = document.getElementById('menu-buttons');
        grid.innerHTML = "";
        Object.keys(data).forEach(key => {
            const btn = document.createElement('button');
            btn.className = "lesson-btn";
            btn.innerText = data[key].title;
            btn.onclick = () => loadTense(key);
            grid.appendChild(btn);
        });
    }

    function loadTense(key) {
        currentTense = key;
        const t = data[key];
        document.getElementById('rule-content').innerHTML = `<h2>${t.title}</h2><p><b>Usage:</b> ${t.usage}</p>${t.table}`;
        document.getElementById('menu-card').style.display = 'none';
        document.getElementById('rule-card').style.display = 'block';
    }

    function toggleModal(show) {
        if (show) {
            const t = data[currentTense];
            const cList = t.contractions.map(c => `<li>${c}</li>`).join('');
            document.getElementById('modal-body').innerHTML = `<h3>${t.title}</h3>${t.table}<div style="background:#e8f0fe;padding:15px;border-radius:10px;"><b>Accepted Contractions:</b><ul>${cList}</ul></div>`;
            document.getElementById('rules-modal').style.display = 'block';
        } else { document.getElementById('rules-modal').style.display = 'none'; }
    }

    function startQuiz() {
        currentIdx = 0; userAnswers = [];
        document.getElementById('rule-card').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        showQuestion();
    }

    function showQuestion() {
        const q = data[currentTense].questions[currentIdx];
        document.getElementById('current-tense-display').innerText = data[currentTense].title;
        document.getElementById('prev-btn').style.visibility = (currentIdx > 0) ? 'visible' : 'hidden';
        document.getElementById('question-area').innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                <span style="font-weight:bold; color:#666;">Question ${currentIdx+1} of 10</span>
                <span onclick="toggleModal(true)" style="color:var(--primary);cursor:pointer; font-weight:bold;">üìñ Rules & Tips</span>
            </div>
            <h3 style="font-size: 1.4rem;">${q.q}</h3>
            <p style="color:#666; font-style:italic;">${q.t}</p>
            <input type="text" id="ans-input" autocomplete="off" placeholder="Type answer here..." onkeypress="if(event.key==='Enter') next()">
            <button onclick="next()" style="width:100%;padding:18px;background:var(--primary);color:white;border:none;border-radius:10px;font-weight:bold;font-size:1rem;cursor:pointer;">Next Question</button>
        `;
        if (userAnswers[currentIdx]) document.getElementById('ans-input').value = userAnswers[currentIdx].user;
        document.getElementById('ans-input').focus();
    }

    function next() {
        const val = document.getElementById('ans-input').value;
        const correct = data[currentTense].questions[currentIdx].a;
        userAnswers[currentIdx] = { q: data[currentTense].questions[currentIdx].q, user: val, correct: correct, isCorrect: clean(val) === clean(correct) };
        currentIdx++;
        if (currentIdx < 10) showQuestion(); else showResults();
    }

    function prevQuestion() { if (currentIdx > 0) { currentIdx--; showQuestion(); } }

    function showResults() {
        const score = userAnswers.filter(a => a.isCorrect).length;
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        document.getElementById('score-summary').innerHTML = `<p style="margin:0; font-size:1.1rem; color:#666;">${studentName}</p><h1 style="font-size:4rem; margin:10px 0; color:var(--primary);">${score*10}%</h1><p style="margin:0;">Score: ${score}/10</p>`;
        
        let rev = ""; 
        userAnswers.forEach((a, i) => { 
            rev += `<div class="review-item"><b>Q${i+1}: ${a.q}</b><br>
                    <span class="${a.isCorrect?'correct-ans':'wrong-ans'}">${a.user||"(No Answer)"}</span> 
                    ${!a.isCorrect ? `| Correct: <span class="correct-ans">${a.correct}</span>` : ''}</div>`; 
        });
        document.getElementById('review-list').innerHTML = rev;
    }

    function backToHome() {
        document.querySelectorAll('.card').forEach(c => c.style.display='none');
        document.getElementById('menu-card').style.display='block';
    }

async function saveAsPDF() {
    const { jsPDF } = window.jspdf;
    const btn = event.target;
    btn.innerText = "Generating PDF..."; // Feedback for user
    
    try {
        const canvas = await html2canvas(document.getElementById('capture-area'), {
            scale: 2, // High resolution
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff"
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${studentName}_English_Test_Result.pdf`);
        
        btn.innerText = "üìÑ Save Result as PDF";
    } catch (error) {
        console.error("PDF Error:", error);
        alert("Could not generate PDF. Please try taking a screenshot instead.");
        btn.innerText = "üìÑ Save Result as PDF";
    }
}
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Calculate dimensions to fit the PDF page
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    
    pdf.addImage(imgData, 'PNG', 0, 10, pdfWidth, pdfHeight);
    pdf.save(`${studentName}_English_Result.pdf`);
}
</script>
</body>
</html>
